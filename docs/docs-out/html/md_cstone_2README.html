<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rasterizationAndFFT + Cornerstone API: Cornerstone octree - a distributed domain and octree for N-body simulations on GPUs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">rasterizationAndFFT + Cornerstone API
   </div>
   <div id="projectbrief">Distributed octree domain, rasterization, and FFT utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_cstone_2README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Cornerstone octree - a distributed domain and octree for N-body simulations on GPUs</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md13"></a> Cornerstone octree is a C++/CUDA library for</p><ul>
<li><b>3D Morton and Hilbert keys:</b> encoding/decoding in 32 and 64 bits</li>
<li><b>Octrees:</b> local and distributed octree builds from x,y,z coordinates, linear buffer storage format</li>
<li><b>Halo discovery:</b> identify halo nodes in a global octree, using a 3D collision detection algorithm.</li>
<li><b>Neighbor searching:</b> find particle neighbors within a given radius.</li>
<li><b>Particle exchange:</b> exchange elements of local coordinate arrays to whip them into shape as defined by a global octree, including halo particles.</li>
</ul>
<p>All of these components are combined into a <b>global domain</b> to manage distributed particles unified under a global octree. But of course, each component can also be used on its own to build domains with different behaviors.</p>
<p>Cornerstone octree is written in C++20 and CUDA with no external software dependencies, except for the GTest framework, used to compile the unit tests and automatically downloaded by CMake. It can run entirely on GPUs (AMD and NVIDIA), though a CPU version is provided as well.</p>
<h3><a class="anchor" id="autotoc_md14"></a>
Folder structure</h3>
<div class="fragment"><div class="line">cornerstone-octree</div>
<div class="line">|   README.md</div>
<div class="line">└───include/cstone/       - folder containing all domain and octree functionality</div>
<div class="line">└───test/</div>
<div class="line">    └───integration_mpi/  - MPI-enabled integration tests between different units</div>
<div class="line">    └───performance/      - performance test cases</div>
<div class="line">    └───unit/             - (non-MPI) unit tests</div>
<div class="line">    └───unit_cuda/        - CUDA unit tests</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md15"></a>
Compilation</h3>
<p>Host <code>.cpp</code> translation units require a C++20 compiler (GCC 11 and later, Clang 14 and later), while <code>.cu</code> translation units are compiled in the C++17 standard. CUDA version: 11.6 or later, HIP version 5.2 or later.</p>
<p>Example CMake invocation: </p><div class="fragment"><div class="line">CC=mpicc CXX=mpicxx cmake -DCMAKE_CUDA_ARCHITECTURES=60,80,90 -DGPU_DIRECT=&lt;ON/OFF&gt; -DCMAKE_CUDA_FLAGS=-ccbin=mpicxx &lt;GIT_SOURCE_DIR&gt;</div>
</div><!-- fragment --><p>GPU-direct (RDMA) MPI communication can be turned on or off by supplying <code>-D GPU_DIRECT=ON</code>. Default is <code>OFF</code>.</p>
<p>In order to build the code for AMD GPUs, the source code (<code>.cuh</code> and <code>.cu</code> only) must be hipified. CMake files are already prepared to work with HIP and should not need to be modified.</p>
<div class="fragment"><div class="line">cd &lt;GIT_SOURCE_DIR&gt;</div>
<div class="line">hipify-perl -inplace `find -name *.cuh -o -name *.cu` &amp;&amp; find -name *.prehip -delete</div>
<div class="line">CC=mpicc CXX=mpicxx cmake -DCMAKE_HIP_ARCHITECTURES=gfx90a -DGPU_DIRECT=&lt;ON/OFF&gt; &lt;GIT_SOURCE_DIR&gt;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md16"></a>
Run</h3>
<p>A minimal sketch of what a client program employing the full domain might look like is listed below.</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="domain_8hpp.html">cstone/domain/domain.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>Real    = double;</div>
<div class="line"><span class="keyword">using </span><a class="code hl_typedef" href="mesh_8hpp.html#ad29765d017498143e4586d5d86b9f32b">KeyType</a> = unsigned;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="power__spectrum_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> rank = 0, numRanks = 0;</div>
<div class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</div>
<div class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;numRanks);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// fill x,y,z,h with some initial values on each rank</span></div>
<div class="line">    std::vector&lt;Real&gt; x{<span class="comment">/*...*/</span>}, y{<span class="comment">/*...*/</span>}, z{<span class="comment">/*...*/</span>}, h{<span class="comment">/*...*/</span>};</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">int</span> bucketSize = 10;</div>
<div class="line">    <a class="code hl_class" href="classcstone_1_1Domain.html">cstone::Domain&lt;KeyType, Real&gt;</a> domain(rank, numRanks, bucketSize) ;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">int</span> nIterations = 10;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iter = 0; iter &lt; nIterations; ++iter)</div>
<div class="line">    {</div>
<div class="line">        domain.sync(x,y,z,h);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// x,y,z,h now contain all particles of a part of the global octree,</span></div>
<div class="line">        <span class="comment">// including their halos.</span></div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Real&gt; density(x.size());</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// compute physical quantities, e.g. densities for particles in the assigned ranges:</span></div>
<div class="line">        <span class="comment">// computeDensity(density,x,y,z,h,domain.startIndex(),domain.endIndex());</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// repeat the halo exchange for densities</span></div>
<div class="line">        domain.exchangeHalos(density);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// compute more quantities and finally update particle positions in x,y,z and h,</span></div>
<div class="line">        <span class="comment">// then start over</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aclasscstone_1_1Domain_html"><div class="ttname"><a href="classcstone_1_1Domain.html">cstone::Domain</a></div><div class="ttdef"><b>Definition</b> domain.hpp:67</div></div>
<div class="ttc" id="adomain_8hpp_html"><div class="ttname"><a href="domain_8hpp.html">domain.hpp</a></div><div class="ttdoc">A domain class to manage distributed particles and their halos.</div></div>
<div class="ttc" id="amesh_8hpp_html_ad29765d017498143e4586d5d86b9f32b"><div class="ttname"><a href="mesh_8hpp.html#ad29765d017498143e4586d5d86b9f32b">KeyType</a></div><div class="ttdeci">uint64_t KeyType</div><div class="ttdef"><b>Definition</b> mesh.hpp:7</div></div>
<div class="ttc" id="apower__spectrum_8cpp_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="power__spectrum_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition</b> power_spectrum.cpp:14</div></div>
</div><!-- fragment --><p>Cornerstone contains unit, integration and regression tests</p>
<p>The following integration tests represent fully functional versions of the program sketch above:</p><ul>
<li><code>test/integration_mpi/domain_nranks</code> (CPU version)</li>
<li><code>test/integration_mpi/domain_gpu</code> (GPU version)</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
Authors</h1>
<ul>
<li><b>Sebastian Keller</b></li>
</ul>
<h1><a class="anchor" id="autotoc_md18"></a>
License</h1>
<p>This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Paper references</h1>
<ul>
<li><a href="https://dl.acm.org/doi/abs/10.1145/3592979.3593417">Keller, S., Cavelan, A., Cabezon, R. M., Mayer L., Ciorba, F. M. (2023) Cornerstone: Octree Construction Algorithms for Scalable Particle Simulations. (PASC '23)</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md20"></a>
Thanks / see also</h1>
<ul>
<li><a href="https://github.com/unibas-dmi-hpc/SPH-EXA_mini-app">PASC SPH-EXA project</a></li>
<li>Aurélien Cavelan <a href="https://github.com/acavelan">@acavelan</a> for his recursive/heap-allocation based octree implementation which served as a precursor for this work.</li>
<li>This <a href="https://fgiesen.wordpress.com/2009/12/13/decoding-morton-codes/">blog post</a> about decoding Morton codes</li>
<li>This NVidia developer <a href="https://developer.nvidia.com/blog/thinking-parallel-part-i-collision-detection-gpu/">blog post trilogy</a> on 3D collision detection </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
